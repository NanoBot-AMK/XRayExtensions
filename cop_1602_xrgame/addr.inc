; в IDA адреса - это абсолютные виртуальные адреса, с допущением, что dll загружена по базовому адресу из
; заголовка. Эти же адреса стоят в генерируемых директивах org

; в MASM директива org задаёт смещение от начала первой секции. 
; Для корректного переноса необходимо вычислить смещение.

; определяем необходимые константы

; исходные данные (получаем из PeTool):
; базовый адрес целевой dll
b_addr TEXTEQU <10000000h>
; RVA первой секции (всегда равен 1000h)
sec1_rva TEXTEQU <1000h>
; RVA второй секции
sec2_rva TEXTEQU <006F2000h>

; константы для настройки нашего кода, облегчающие подстройку:
; виртуальный адрес первой секции всегда равен базовому + RVA секции
; в MASM директива org 0 соответствует этому адресу
sec1_addr EQU (b_addr + sec1_rva)
; псевдоним для последующего употребления в директивах org
shift EQU sec1_addr
; виртуальный адрес второй секции
sec2_addr EQU (b_addr + sec2_rva)
; смещение между началом второй и первой секции в целевой dll
sec1_sec2_dist EQU (sec2_rva - sec1_rva)
; здесь будет иметь смысл размера первого сегмента
; для этого в конец первого сегмента вставляется холостое однобайтовое значение
; по заданному алресу:
; org sec1_sec2_dist - 1
; db 0

; теперь при переносе фрагментов из IDA указываем в директиве org
; org <значение адреса из IDA> - shift
